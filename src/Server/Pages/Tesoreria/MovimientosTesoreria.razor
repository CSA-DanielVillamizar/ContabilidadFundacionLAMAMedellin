@page "/tesoreria/movimientos"
@using Server.Data
@using Server.Models
@using Server.Services.MovimientosTesoreria
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "Admin,Tesorero")]

<PageTitle>Movimientos de Tesorer√≠a</PageTitle>

<h3>Movimientos de Tesorer√≠a - Ledger Oficial</h3>

<div class="alerts" style="margin-bottom:1rem;">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>‚ùå Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="ClearErrors"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>‚úÖ √âxito:</strong> @successMessage
            <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
        </div>
    }
</div>

<!-- FILTROS -->
<div class="card" style="padding:1rem; margin-bottom:1rem;">
    <h5>Filtros</h5>
    <div class="row">
        <div class="col-md-2">
            <label>Inicio:</label>
            <input type="date" @bind="filtroInicio" class="form-control form-control-sm" />
        </div>
        <div class="col-md-2">
            <label>Fin:</label>
            <input type="date" @bind="filtroFin" class="form-control form-control-sm" />
        </div>
        <div class="col-md-2">
            <label>Cuenta:</label>
            <select @bind="filtroCuenta" class="form-control form-control-sm">
                <option value="">(Todas)</option>
                @foreach (var c in cuentas)
                {
                    <option value="@c.Id">@c.Nombre</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label>Tipo:</label>
            <select @bind="filtroTipo" class="form-control form-control-sm">
                <option value="">(Todos)</option>
                <option value="@TipoMovimientoTesoreria.Ingreso">Ingreso</option>
                <option value="@TipoMovimientoTesoreria.Egreso">Egreso</option>
            </select>
        </div>
        <div class="col-md-2">
            <label>Estado:</label>
            <select @bind="filtroEstado" class="form-control form-control-sm">
                <option value="">(Todos)</option>
                <option value="@EstadoMovimientoTesoreria.Borrador">Borrador</option>
                <option value="@EstadoMovimientoTesoreria.Aprobado">Aprobado</option>
                <option value="@EstadoMovimientoTesoreria.Anulado">Anulado</option>
            </select>
        </div>
        <div class="col-md-2" style="padding-top:1.5rem;">
            <button @onclick="CargarMovimientos" class="btn btn-primary btn-sm">üîç Filtrar</button>
        </div>
    </div>
</div>

<!-- BOT√ìN NUEVO MOVIMIENTO -->
<button @onclick="PrepararNuevo" class="btn btn-success btn-sm" style="margin-bottom:1rem;">
    ‚ûï Nuevo Movimiento
</button>

<!-- FORMULARIO NUEVO/EDITAR/ANULAR -->
@if (modo != "list")
{
    <div class="card" style="padding:1rem; margin-bottom:1rem; border-left: 4px solid #007bff;">
        <h5>@(modo == "create" ? "Nuevo Movimiento" : modo == "edit" ? $"Editar: {formularioMovimiento?.NumeroMovimiento}" : $"Anular: {formularioMovimiento?.NumeroMovimiento}")</h5>
        
        @if (modo == "create" || modo == "edit")
        {
            <div class="row" style="margin-bottom:0.5rem;">
                <div class="col-md-3">
                    <label><strong>N√∫mero:</strong></label>
                    <input type="text" @bind="formularioMovimiento.NumeroMovimiento" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label><strong>Fecha:</strong></label>
                    <input type="datetime-local" @bind="formularioMovimiento.Fecha" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label><strong>Cuenta:</strong></label>
                    <select @bind="formularioMovimiento.CuentaFinancieraId" class="form-control form-control-sm">
                        <option value="">-- Seleccionar --</option>
                        @foreach (var c in cuentas)
                        {
                            <option value="@c.Id">@c.Nombre</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label><strong>Tipo:</strong></label>
                    <select @bind="formularioMovimiento.Tipo" class="form-control form-control-sm">
                        <option value="@TipoMovimientoTesoreria.Ingreso">Ingreso</option>
                        <option value="@TipoMovimientoTesoreria.Egreso">Egreso</option>
                    </select>
                </div>
            </div>

            <div class="row" style="margin-bottom:0.5rem;">
                <div class="col-md-3">
                    <label><strong>Valor:</strong></label>
                    <input type="number" step="0.01" @bind="formularioMovimiento.Valor" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label><strong>Medio Pago:</strong></label>
                    <select @bind="formularioMovimiento.Medio" class="form-control form-control-sm">
                        @foreach (var m in Enum.GetValues<MedioPagoTesoreria>())
                        {
                            <option value="@m">@m</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label><strong>Fuente Ingreso:</strong></label>
                    <select @bind="formularioMovimiento.FuenteIngresoId" class="form-control form-control-sm">
                        <option value="">(N/A)</option>
                        @foreach (var f in fuentes)
                        {
                            <option value="@f.Id">@f.Nombre</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label><strong>Categor√≠a Egreso:</strong></label>
                    <select @bind="formularioMovimiento.CategoriaEgresoId" class="form-control form-control-sm">
                        <option value="">(N/A)</option>
                        @foreach (var cat in categorias)
                        {
                            <option value="@cat.Id">@cat.Nombre</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row" style="margin-bottom:1rem;">
                <div class="col-md-6">
                    <label><strong>Descripci√≥n:</strong></label>
                    <textarea @bind="formularioMovimiento.Descripcion" class="form-control form-control-sm" rows="2"></textarea>
                </div>
                <div class="col-md-6">
                    <label><strong>Referencia Transacci√≥n:</strong></label>
                    <input type="text" @bind="formularioMovimiento.ReferenciaTransaccion" class="form-control form-control-sm" />
                </div>
            </div>
        }

        @if (modo == "anular")
        {
            <div style="margin-bottom:1rem;">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Anulando:</strong> @formularioMovimiento.NumeroMovimiento
                    <br />Valor: $@formularioMovimiento.Valor:N0
                    <br />Fecha: @formularioMovimiento.Fecha:g
                </div>
                <label><strong>Motivo de Anulaci√≥n:</strong></label>
                <textarea @bind="motivoAnulacion" class="form-control form-control-sm" rows="3" placeholder="Explicar por qu√© se anula este movimiento..."></textarea>
            </div>
        }

        <div>
            @if (modo == "create")
            {
                <button @onclick="GuardarNuevo" class="btn btn-success btn-sm">‚úÖ Crear</button>
            }
            else if (modo == "edit")
            {
                <button @onclick="GuardarEdicion" class="btn btn-warning btn-sm">‚úèÔ∏è Actualizar</button>
            }
            else if (modo == "anular")
            {
                <button @onclick="GuardarAnulacion" class="btn btn-danger btn-sm">üõë Anular Movimiento</button>
            }
            <button @onclick="CancelarFormulario" class="btn btn-secondary btn-sm">Cancelar</button>
        </div>
    </div>
}

<!-- TABLA MOVIMIENTOS -->
<div style="overflow-x: auto;">
    <table class="table table-striped table-hover" style="font-size:0.9rem; margin-top:1rem;">
        <thead class="table-dark">
            <tr>
                <th>N√∫mero</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>Cuenta</th>
                <th>Estado</th>
                <th>Creado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (movimientos.Count > 0)
            {
                @foreach (var m in movimientos)
                {
                    <tr>
                        <td><strong>@m.NumeroMovimiento</strong></td>
                        <td>@m.Fecha:d</td>
                        <td>
                            @if (m.Tipo == TipoMovimientoTesoreria.Ingreso)
                            {
                                <span class="badge bg-success">‚Üì Ingreso</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">‚Üë Egreso</span>
                            }
                        </td>
                        <td class="text-end"><strong>${@m.Valor:N0}</strong></td>
                        <td>@cuentas.FirstOrDefault(c => c.Id == m.CuentaFinancieraId)?.Nombre</td>
                        <td>
                            @if (m.Estado == EstadoMovimientoTesoreria.Borrador)
                            {
                                <span class="badge bg-secondary">Borrador</span>
                            }
                            else if (m.Estado == EstadoMovimientoTesoreria.Aprobado)
                            {
                                <span class="badge bg-success">Aprobado</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Anulado</span>
                            }
                        </td>
                        <td>@m.CreatedBy<br />@m.CreatedAt:g</td>
                        <td>
                            <button @onclick="() => PrepararEdicion(m.Id)" class="btn btn-warning btn-sm btn-sm" style="padding:2px 6px; font-size:0.8rem;" title="Editar">‚úèÔ∏è</button>
                            @if (m.Estado != EstadoMovimientoTesoreria.Anulado)
                            {
                                <button @onclick="() => PrepararAnulacion(m.Id)" class="btn btn-danger btn-sm" style="padding:2px 6px; font-size:0.8rem;" title="Anular">üõë</button>
                            }
                            <button @onclick="() => MostrarDetalle(m)" class="btn btn-info btn-sm" style="padding:2px 6px; font-size:0.8rem;" title="Detalle">üëÅÔ∏è</button>
                        </td>
                    </tr>

                    @if (detalleMovimientoId == m.Id)
                    {
                        <tr class="table-info">
                            <td colspan="8" style="padding:1rem;">
                                <strong>Descripci√≥n:</strong> @m.Descripcion<br />
                                <strong>Medio Pago:</strong> @m.Medio<br />
                                @if (!string.IsNullOrEmpty(m.ReferenciaTransaccion))
                                {
                                    <strong>Referencia:</strong> @m.ReferenciaTransaccion<br />
                                }
                                @if (m.Estado == EstadoMovimientoTesoreria.Anulado && !string.IsNullOrEmpty(m.MotivoAnulacion))
                                {
                                    <div class="alert alert-danger" style="margin-top:0.5rem; margin-bottom:0;">
                                        <strong>‚ö†Ô∏è Motivo Anulaci√≥n:</strong> @m.MotivoAnulacion<br />
                                        <strong>Anulado por:</strong> @m.UsuarioAnulacion<br />
                                        <strong>Fecha Anulaci√≥n:</strong> @m.FechaAnulacion:g
                                    </div>
                                }
                                <button @onclick="OcultarDetalle" class="btn btn-sm btn-secondary" style="margin-top:0.5rem;">Cerrar</button>
                            </td>
                        </tr>
                    }
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center text-muted">No hay movimientos que coincidan con los filtros</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    [Inject] AppDbContext Db { get; set; } = default!;
    [Inject] MovimientosTesoreriaService MovimientosService { get; set; } = default!;
    [Inject] IHttpContextAccessor HttpContext { get; set; } = default!;

    private List<MovimientoTesoreria> movimientos = new();
    private List<CuentaFinanciera> cuentas = new();
    private List<FuenteIngreso> fuentes = new();
    private List<CategoriaEgreso> categorias = new();

    private MovimientoTesoreria formularioMovimiento = new();
    private string modo = "list"; // list, create, edit, anular
    private Guid? detalleMovimientoId;
    private string motivoAnulacion = "";
    
    private string? errorMessage;
    private string? successMessage;

    private DateTime? filtroInicio;
    private DateTime? filtroFin;
    private Guid? filtroCuenta;
    private TipoMovimientoTesoreria? filtroTipo;
    private EstadoMovimientoTesoreria? filtroEstado;

    private string CurrentUser => HttpContext.HttpContext?.User?.Identity?.Name ?? "system";

    protected override async Task OnInitializedAsync()
    {
        cuentas = await Db.CuentasFinancieras.OrderBy(c => c.Nombre).ToListAsync();
        fuentes = await Db.FuentesIngreso.OrderBy(f => f.Nombre).ToListAsync();
        categorias = await Db.CategoriasEgreso.OrderBy(c => c.Nombre).ToListAsync();
        await CargarMovimientos();
    }

    private async Task CargarMovimientos()
    {
        try
        {
            movimientos = await MovimientosService.ListAsync(
                inicio: filtroInicio,
                fin: filtroFin,
                cuentaId: filtroCuenta,
                tipo: filtroTipo,
                estado: filtroEstado,
                maxResults: 500
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar movimientos: {ex.Message}";
        }
    }

    // CREATE
    private void PrepararNuevo()
    {
        ClearMessages();
        modo = "create";
        formularioMovimiento = new MovimientoTesoreria
        {
            NumeroMovimiento = $"MV-{DateTime.UtcNow:yyyy}-{Guid.NewGuid().ToString()[..6].ToUpper()}",
            Fecha = DateTime.UtcNow,
            Tipo = TipoMovimientoTesoreria.Ingreso,
            Medio = MedioPagoTesoreria.Transferencia,
            CuentaFinancieraId = Guid.Empty
        };
    }

    private async Task GuardarNuevo()
    {
        try
        {
            await MovimientosService.CreateAsync(formularioMovimiento, CurrentUser);
            successMessage = $"‚úÖ Movimiento {formularioMovimiento.NumeroMovimiento} creado exitosamente.";
            modo = "list";
            await CargarMovimientos();
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    // EDIT
    private async Task PrepararEdicion(Guid id)
    {
        ClearMessages();
        try
        {
            var movimiento = await MovimientosService.GetByIdAsync(id);
            if (movimiento != null)
            {
                formularioMovimiento = movimiento;
                modo = "edit";
            }
            else
            {
                errorMessage = "Movimiento no encontrado";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task GuardarEdicion()
    {
        try
        {
            await MovimientosService.UpdateAsync(formularioMovimiento.Id, formularioMovimiento, CurrentUser);
            successMessage = $"‚úÖ Movimiento {formularioMovimiento.NumeroMovimiento} actualizado exitosamente.";
            modo = "list";
            await CargarMovimientos();
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    // ANULAR
    private async Task PrepararAnulacion(Guid id)
    {
        ClearMessages();
        try
        {
            var movimiento = await MovimientosService.GetByIdAsync(id);
            if (movimiento != null)
            {
                formularioMovimiento = movimiento;
                modo = "anular";
                motivoAnulacion = "";
            }
            else
            {
                errorMessage = "Movimiento no encontrado";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task GuardarAnulacion()
    {
        if (string.IsNullOrWhiteSpace(motivoAnulacion))
        {
            errorMessage = "El motivo de anulaci√≥n es obligatorio";
            return;
        }

        try
        {
            await MovimientosService.AnularAsync(formularioMovimiento.Id, motivoAnulacion, CurrentUser);
            successMessage = $"‚úÖ Movimiento {formularioMovimiento.NumeroMovimiento} anulado exitosamente.";
            modo = "list";
            await CargarMovimientos();
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    // DETALLES
    private void MostrarDetalle(MovimientoTesoreria m)
    {
        detalleMovimientoId = m.Id == detalleMovimientoId ? null : m.Id;
    }

    private void OcultarDetalle()
    {
        detalleMovimientoId = null;
    }

    private void CancelarFormulario()
    {
        modo = "list";
        formularioMovimiento = new();
        motivoAnulacion = "";
        ClearMessages();
    }

    private void ClearMessages()
    {
        errorMessage = null;
        successMessage = null;
    }

    private void ClearErrors() => errorMessage = null;
    private void ClearSuccess() => successMessage = null;
}
