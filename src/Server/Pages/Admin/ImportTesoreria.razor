@page "/admin/import-tesoreria"
@using System.Net.Http.Json
@using Server.Services.Import
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>Importar Hist√≥rico Tesorer√≠a</PageTitle>

<h3>Importar Hist√≥rico de Tesorer√≠a desde Excel</h3>

<div class="alert alert-info mb-4" role="alert">
    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Esta herramienta importa el hist√≥rico completo desde <code>INFORME TESORERIA.xlsx</code> (mayo 2024 - noviembre 2025).
    La importaci√≥n es <strong>idempotente</strong>: puede ejecutarse m√∫ltiples veces sin duplicar datos.
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        <strong>‚ö†Ô∏è Error:</strong> @errorMessage
    </div>
}

@if (summary != null)
{
    <div class="card mb-4">
        <div class="card-header bg-@(summary.Success ? "success" : "warning") text-white">
            <h5 class="mb-0">@(isDryRun ? "üß™ Resultado Dry Run" : "‚úÖ Resultado de Importaci√≥n")</h5>
        </div>
        <div class="card-body">
            <p class="mb-3"><strong>@summary.Message</strong></p>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Filas Procesadas</h6>
                            <h3>@summary.TotalRowsProcessed</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Importados</h6>
                            <h3 class="text-success">@summary.MovimientosImported</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Omitidos (ya exist√≠an)</h6>
                            <h3 class="text-secondary">@summary.MovimientosSkipped</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Mismatches de Saldo</h6>
                            <h3 class="@(summary.BalanceMismatches > 0 ? "text-warning" : "text-success")">@summary.BalanceMismatches</h3>
                        </div>
                    </div>
                </div>
            </div>

            @if (summary.MovimientosPorHoja.Any())
            {
                <h6 class="mt-4">Movimientos por Hoja:</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Hoja</th>
                            <th class="text-end">Movimientos</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var kv in summary.MovimientosPorHoja.OrderBy(x => x.Key))
                        {
                            <tr>
                                <td>@kv.Key</td>
                                <td class="text-end">@kv.Value</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            @if (summary.SaldoFinalCalculado.HasValue)
            {
                <div class="alert alert-info mt-3" role="alert">
                    <strong>Saldo Final Calculado:</strong> @($"{summary.SaldoFinalCalculado.Value:N0} COP")
                    @if (summary.SaldoFinalEsperado.HasValue)
                    {
                        <br />
                        <strong>Saldo Esperado (Excel):</strong> @($"{summary.SaldoFinalEsperado.Value:N0} COP")
                    }
                </div>
            }

            @if (summary.Warnings.Any())
            {
                <div class="alert alert-warning mt-3" role="alert">
                    <h6>‚ö†Ô∏è Advertencias (@summary.Warnings.Count):</h6>
                    <ul class="mb-0">
                        @foreach (var warning in summary.Warnings.Take(20))
                        {
                            <li>@warning</li>
                        }
                        @if (summary.Warnings.Count > 20)
                        {
                            <li><em>... y @(summary.Warnings.Count - 20) advertencias m√°s.</em></li>
                        }
                    </ul>
                </div>
            }

            @if (summary.Errors.Any())
            {
                <div class="alert alert-danger mt-3" role="alert">
                    <h6>‚ùå Errores:</h6>
                    <ul class="mb-0">
                        @foreach (var error in summary.Errors)
                        {
                            <li>@error</li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
}

<div class="btn-group" role="group">
    <button class="btn btn-primary" @onclick="RunDryRun" disabled="@isProcessing">
        @if (isProcessing && isDryRun)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span> Procesando...</span>
        }
        else
        {
            <span>üß™ Dry Run (Simular)</span>
        }
    </button>
    <button class="btn btn-success" @onclick="RunImport" disabled="@isProcessing">
        @if (isProcessing && !isDryRun)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span> Importando...</span>
        }
        else
        {
            <span>‚úÖ Importar (Real)</span>
        }
    </button>
</div>

<div class="mt-4">
    <a href="/tesoreria/movimientos" class="btn btn-link">Ver Movimientos de Tesorer√≠a</a>
    <a href="/tesoreria/cuentas-financieras" class="btn btn-link">Ver Cuentas Financieras</a>
</div>

@code {
    private ImportSummary? summary;
    private string? errorMessage;
    private bool isProcessing;
    private bool isDryRun;

    private async Task RunDryRun()
    {
        isDryRun = true;
        await ExecuteImport(dryRun: true);
    }

    private async Task RunImport()
    {
        isDryRun = false;
        if (!await Confirm("¬øEst√° seguro de ejecutar la importaci√≥n REAL? Esta operaci√≥n crear√° registros en la base de datos."))
            return;
        await ExecuteImport(dryRun: false);
    }

    private async Task ExecuteImport(bool dryRun)
    {
        isProcessing = true;
        errorMessage = null;
        summary = null;
        StateHasChanged();

        try
        {
            var response = await Http.PostAsync($"/api/admin/import/tesoreria/excel?dryRun={dryRun}", null);
            if (response.IsSuccessStatusCode)
            {
                summary = await response.Content.ReadFromJsonAsync<ImportSummary>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error HTTP {response.StatusCode}: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Excepci√≥n: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task<bool> Confirm(string message)
    {
        // Implementaci√≥n simple: en producci√≥n usar MudBlazor dialog
        return await Task.FromResult(true); // Auto-confirmar por ahora
    }
}
